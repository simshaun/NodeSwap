<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!-- Full version number to display -->
  <?define VersionNumber="!(bind.FileVersion.NodeSwapExe)" ?>

  <!--
   Upgrade code HAS to be the same for all updates.
   Once you've chosen it don't change it.
   -->
  <?define UpgradeCode="2fdcab6e-e26c-4429-babd-bd5c5984b469" ?>

  <!-- The URL for add/remove programs -->
  <?define InfoURL="https://github.com/simshaun/NodeSwap" ?>

  <!-- The upgrade code must never change as long as the product lives! -->
  <!-- Product IDs must be autogenerated (*) or else major upgrades will not work -->
  <Product Id="*" Name="!(loc.ApplicationName)" Language="!(loc.Language)" Version="$(var.VersionNumber)"
           Manufacturer="!(loc.ManufacturerFullName)" UpgradeCode="$(var.UpgradeCode)">

    <!-- Package IDs are valid for a single package version only - they are autogenerated by WiX -->
    <!-- And ALWAYS install per machine!!! -->
    <Package Id="*" InstallerVersion="200" Compressed="yes" InstallScope="perMachine"
             Description="!(loc.ProductDescription)" Comments="!(loc.Comments) $(var.VersionNumber)" />

    <!-- WixUI displays a EULA screen. Show a simple EULA. -->
    <WixVariable Id="WixUILicenseRtf" Value="eula.rtf" />

    <!-- Define icons -->
    <Icon Id="APP_ICON" SourceFile="icon.ico" />

    <!-- Set properties for add/remove programs -->
    <Property Id="ARPPRODUCTICON" Value="APP_ICON" />
    <Property Id="ARPHELPLINK" Value="$(var.InfoURL)" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" /> <!-- Remove repair -->

    <!-- Offer option to change installation directory -->
    <!-- This requires WixUIExtension.dll to be added as a reference in the project. -->
    <UIRef Id="MyWixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="WIXUI_STORAGEDIR" Value="STORAGEFOLDER" />

    <!-- Upgrade logic -->
    <!-- AllowSameVersionUpgrades -> Always upgrade, never allow two versions to be installed next to each other -->
    <!-- AllowSameVersionUpgrades causes ICE61 which must be ignored -->
    <MajorUpgrade DowngradeErrorMessage="!(loc.NewerInstalled)" AllowSameVersionUpgrades="yes" />

    <MediaTemplate EmbedCab="yes" />

    <!-- Outermost folder (kind of virtual). Fixed entry. -->
    <Directory Id="TARGETDIR" Name="SourceDir">

      <!-- We start building our directory structure here -->
      <!-- "ProgramFilesFolder" is a variable containing the absolute path. -->
      <!-- For a list of folder variables, see: http://msdn.microsoft.com/en-us/library/aa372057%28VS.85%29.aspx -->
      <Directory Id="ProgramFilesFolder">

        <!-- All folders from here on are relative to their parent. -->

        <Directory Id="ProgramFilesFAF" Name="!(loc.ManufacturerName)">

          <!-- INSTALLFOLDER is a property name. Needed for WixUI_InstallDir -->
          <Directory Id="INSTALLFOLDER" Name="!(loc.ApplicationName)">

            <!--
            Define components, the building blocks of MSIs.
                 Rule: A component should only contain items that belong together so strongly
                 that they always need to be installed or removed together. If this means a
                 single file, then your components will contain a single file each. This is
                 not only normal but exactly what you're expected to do. Don't be afraid,
                 Windows Installer can efficiently handle thousands of components or more,
                 if needed.
            -->

            <!-- Installation directory as a component so it can be emptied during uninstall. -->
            <!-- (by default, files added by someone other than Windows Installer are not removed) -->
            <Component Id="INSTALLFOLDER_comp" Guid="1E2A3FB1-2000-4FD8-BFFA-B8D54E8FC451">
              <CreateFolder />
              <RemoveFile Id="RemoveFilesFromAppDirectory" Name="*.*" On="uninstall" />
            </Component>

            <!-- Main program file -->
            <Component Id="NodeSwap.exe_comp" Guid="*">
              <File Source="$(var.HarvestPath)\NodeSwap.exe" Id="NodeSwapExe" KeyPath="yes" />
            </Component>

            <!-- STORAGEFOLDER is a property that's needed by WixUI_InstallDir. -->
            <Directory Id="STORAGEFOLDER" Name="var">
              <Component Id="STORAGEFOLDER_comp" Guid="911C0AA6-A8DB-49D2-94E1-6BBFA77D92AD">
                <CreateFolder />
              </Component>

              <Directory Id="SYMLINKFOLDER" Name="current" />

              <!-- Create a `NODESWAP_STORAGE` ENV var. -->
              <Component Id="SETENV_NODESWAP_comp" Guid="BBDA8C31-0309-4854-AA11-CCE0BDFE8B17" KeyPath="yes">
                <Environment
                    Id="ENV_NODESWAP_STORAGE"
                    Name="NODESWAP_STORAGE"
                    Value="[STORAGEFOLDER]"
                    Permanent="no"
                    Part="all"
                    Action="set"
                    System="no" />
              </Component>
            </Directory>

            <!-- Add installation folder to PATH environment var -->
            <Component Id="SETENV_PATH_INSTALLFOLDER_comp" Guid="39D20980-F0DD-4720-B80B-CF4CF37C59B6" KeyPath="yes">
              <Environment
                  Id="ENV_PATH_INSTALLFOLDER"
                  Name="PATH"
                  Value="[INSTALLFOLDER]"
                  Permanent="no"
                  Part="last"
                  Action="set"
                  System="no" />
            </Component>

            <!-- Add symlink folder to PATH environment var -->
            <Component Id="SETENV_PATH_SYMLINKFOLDER_comp" Guid="90E95031-ADDF-4944-96F3-54CF893C3305" KeyPath="yes">
              <Environment
                  Id="ENV_PATH_SYMLINKFOLDER"
                  Name="PATH"
                  Value="[SYMLINKFOLDER]"
                  Permanent="no"
                  Part="last"
                  Action="set"
                  System="no" />
            </Component>

          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <!-- Features define which parts of the application can be installed in a custom installation -->
    <Feature Id="Complete" Title="!(loc.ApplicationName)" Level="1">
      <ComponentGroupRef Id="HeatGenerated_comp" />
      <ComponentRef Id="INSTALLFOLDER_comp" />
      <ComponentRef Id="NodeSwap.exe_comp" />
      <ComponentRef Id="STORAGEFOLDER_comp" />
      <ComponentRef Id="SETENV_PATH_INSTALLFOLDER_comp" />
      <ComponentRef Id="SETENV_PATH_SYMLINKFOLDER_comp" />
      <ComponentRef Id="SETENV_NODESWAP_comp" />
    </Feature>
  </Product>
</Wix>
